<!-- 如你所见 这是模板 -->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="/css/pagestyle.css">
    <link rel="stylesheet" type="text/css" href="/css/bilibili-style.css">
    <style>
        /* 新增投票样式 */
        .vote-container {
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin: 10px;
        }
        .vote-option {
            margin: 10px 0;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .vote-option:hover {
            background: rgba(0,0,0,0.5);
        }
        .results-bar {
            height: 20px;
            background: #555;
            border-radius: 10px;
            margin: 5px 0;
            overflow: hidden;
        }
        .results-fill {
            height: 100%;
            background: #00a1d6;
            transition: width 0.5s;
        }
        #timer {
            color: #ff9f43;
            font-weight: bold;
            font-size: 1.2em;
        }
    </style>
    <meta name="description" content="网页介绍, 给浏览器看的">
    <meta name="keywords" content="搜索关键词">
    <meta name="author" content="作者">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <title>2025狂欢节活动</title>
</head>
<body>
    <div class="header">
        <h1>QB红石VisualNovel</h1>
    </div>
    <div class="container">
        <div class="content">
            <div class="nav list">
                <!-- 直播区块保持不变 -->
                <ul>
                    <div class="block">
                        <div class="bilibili-iframe" style="height: 100%;">
                            <iframe class="bilibili" style="height: 90%;width: 95%"
                                src="https://www.bilibili.com/blackboard/live/live-activity-player.html?cid=1856393864&quality=0"
                                scrolling="no" frameborder="no" allowfullscreen="true"
                                sandbox="allow-top-navigation allow-same-origin allow-forms allow-scripts allow-popups"
                                width="100%" height="80%">
                            </iframe>
                            <script src="/js/bilibili.js"></script>
                        </div>
                    </div>
                </ul>

                <!-- 替换原始按钮部分为投票系统 -->
                <ul>
                    <div class="block">
                        <div class="vote-container">
                            <h2 id="voteQuestion">您希望下次活动在哪里举办？</h2>
                            <div id="voteOptions">
                                <div class="vote-option" onclick="castVote('A')">大礼堂</div>
                                <div class="vote-option" onclick="castVote('B')">体育馆</div>
                                <div class="vote-option" onclick="castVote('C')">操场</div>
                            </div>
                            <div id="voteTimer">
                                剩余时间: <span id="timer">05:00</span>
                            </div>
                            <div id="voteResults" style="display:none;">
                                <h3>投票结果</h3>
                                <div id="resultsContainer"></div>
                            </div>
                        </div>
                    </div>
                </ul>

                <!-- 文案区块保持不变 -->
                <ul>
                    <div class="block">
                        <div class="introduce">
                            文案区
                            这对吗, 对的对的
                            <br><br>
                            大家好啊，这里是QB红石VisualNovel的先行宣传。在狂欢节当天，我们将会为大家呈现一个大型，多人协同的视觉小说活动。现在，每个人都有机会成为活动的贡献者。
                            <br><br>
                            在故事进行中，玩家有机会触发彩蛋，从而获得一定的奖品，为了使得奖品足够有吸引力以及有趣，我们接受奖品赞助。你可以提供任何物品/承诺(*)，我们会将其与彩蛋绑定，于狂欢节时公布。
                            <br><br>
                            作为支持我们的回报，对于每一位赞助者，我们可以为您提供以下权益：<br>
                            1. 您的名字将会被记录在贡献者名单上，与活动一同展出<br>
                            2. 加入赞助者群，参与活动内测<br>
                            3. 在故事中加入您设想的情节(*)<br>
                            4. 在活动期间的qb我的世界校园服务器获得特殊头衔<br>
                            <br>
                            公平起见，赞助者不会被告知彩蛋触发方式相关的信息。
                            <br>
                            活动筹划方：红石设计社，学生电视台，程序设计社，推理社
                            联系人<br>
                            qq：1073171253，wx：w20071203zhizhi<br>
                            (*)内容符合一般高中生形象, 解释权归筹划方所有<br>
                        </div>
                    </div>
                </ul>
            </div>
        </div>

        <!-- 侧边栏保持不变 -->
        <div class="sidebar">
            <p>维护者:zhizhizhiwang、Gcint、FuriousC</p>
            <p>最后修改日期:<span data-file="/carnival/home.html"></span></p>
            <script src="/js/getUpdate.js"></script>
            <p><img src="这里填一个page view badge" /></p>
            <a href=""><p>查看成就</p></a>
            <a href="/home.html"><p>回到主页</p></a>
            <a href="/download.html"><p>下载链接汇总</p></a>
        </div>
    </div>
        <!-- 修改重点：投票系统部分 -->
        <script>
            // 投票系统逻辑（修改开始）
            let voteEndTime = localStorage.getItem('voteEndTime') || (Date.now() + 300000);
            let hasVoted = localStorage.getItem('hasVoted') === 'true';

            // 初始化投票数据（兼容旧版）
            let votes = (() => {
                const stored = JSON.parse(localStorage.getItem('votes')) || { 
                    A: { label: "大礼堂", votes: 0 },
                    B: { label: "体育馆", votes: 0 },
                    C: { label: "操场", votes: 0 }
                };
                
                // 数据迁移：旧数字格式 → 新对象格式
                if (typeof stored.A === 'number') {
                    return {
                        A: { label: "大礼堂", votes: stored.A },
                        B: { label: "体育馆", votes: stored.B },
                        C: { label: "操场", votes: stored.C }
                    };
                }
                return stored;
            })();

            // 动态生成投票选项
            function initVoteOptions() {
                const container = document.getElementById('voteOptions');
                container.innerHTML = Object.entries(votes)
                    .map(([key, data]) => `
                        <div class="vote-option" onclick="castVote('${key}')">
                            ${data.label}
                        </div>
                    `).join('');
            }

            function updateTimer() {
                const now = Date.now();
                const diff = voteEndTime - now;
                
                if (diff <= 0) {
                    showResults();
                    return;
                }

                const minutes = Math.floor(diff / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            function castVote(option) {
                if (hasVoted) return alert('您已经投过票了！');
                if (!votes[option]) return alert('无效选项！');
                
                votes[option].votes++;
                localStorage.setItem('votes', JSON.stringify(votes));
                localStorage.setItem('hasVoted', 'true');
                hasVoted = true;
                alert('投票成功！');
            }

            function showResults() {
                document.getElementById('voteOptions').style.display = 'none';
                document.getElementById('voteTimer').style.display = 'none';
                document.getElementById('voteResults').style.display = 'block';

                const total = Object.values(votes).reduce((sum, item) => sum + item.votes, 0);
                const container = document.getElementById('resultsContainer');
                container.innerHTML = '';

                for (const [option, data] of Object.entries(votes)) {
                    const percent = total === 0 ? 0 : Math.round((data.votes / total) * 100);
                    container.innerHTML += `
                        <div>${data.label}：${data.votes}票 (${percent}%)</div>
                        <div class="results-bar">
                            <div class="results-fill" style="width: ${percent}%"></div>
                        </div>
                    `;
                }
            }

            // 初始化
            initVoteOptions();
            setInterval(updateTimer, 1000);
            updateTimer();
            if (Date.now() > voteEndTime) showResults();
            if (hasVoted) document.getElementById('voteOptions').innerHTML = '<p>感谢您的参与！</p>';

            // 管理员功能（修改后）
            window.setNewVote = (labels, duration) => {
                if (!Array.isArray(labels) || labels.length > 5) {
                    return alert('最多支持5个选项');
                }

                const newVotes = {};
                labels.forEach((label, i) => {
                    const key = String.fromCharCode(65 + i); // A/B/C/D/E
                    newVotes[key] = { label, votes: 0 };
                });

                localStorage.clear();
                localStorage.setItem('votes', JSON.stringify(newVotes));
                localStorage.setItem('voteEndTime', Date.now() + duration * 60000);
                location.reload();
            }
            // 修改结束
        </script>

        <!-- 修改HTML部分 -->
        <div id="voteOptions">
            <!-- 原硬编码选项已删除，改为动态生成 -->
        </div>
        </p>
    </div>
</body>
</html>
